# 微服务架构调用关系总结

## 概述
本文档总结了后端微服务架构中所有服务之间的 Feign 调用关系。

## 微服务列表
1. **auth-service** - 认证服务（用户认证、权限管理）
2. **org-service** - 机构服务（机构管理、成员管理）
3. **pet-service** - 宠物服务（宠物信息管理、健康记录）
4. **adoption-service** - 领养服务（领养申请、领养流程）
5. **interview-service** - 面谈服务（面谈预约、面谈管理）
6. **community-service** - 社区服务（帖子、评论、举报）
7. **notification-service** - 通知服务（通过 RabbitMQ 接收消息）

---

## 微服务调用关系图

```
┌─────────────────┐
│  auth-service   │ (核心服务，被多个服务调用)
└────────┬────────┘
         │
         ├─────────────────────────────────────────────┐
         │                                             │
         ▼                                             ▼
┌─────────────────┐                          ┌─────────────────┐
│  org-service    │                          │  pet-service    │
│                 │                          │                 │
│ 调用:            │                          │ 调用:           │
│ - auth-service   │                          │ - auth-service  │
└────────┬────────┘                          │ - org-service   │
         │                                   │ - adoption-     │
         │                                   │   service       │
         │                                   └────────┬────────┘
         │                                            │
         │                                            │
         ▼                                            ▼
┌─────────────────┐                          ┌─────────────────┐
│adoption-service │                          │interview-service│
│                 │                          │                 │
│ 调用:            │                          │ 调用:           │
│ - auth-service   │                          │ - adoption-     │
│ - org-service    │                          │   service       │
│ - pet-service    │                          │ - org-service   │
└─────────────────┘                          └─────────────────┘

┌─────────────────┐
│community-service│
│                 │
│ 调用:            │
│ - auth-service   │
└─────────────────┘
```

---

## 详细调用关系

### 1. adoption-service（领养服务）

**调用的服务：**
- **auth-service** (`AuthServiceClient`)
  - `getUserList(page, pageSize)` - 获取用户列表（用于通知）

- **org-service** (`OrgServiceClient`)
  - `getOrgDetail(orgId)` - 获取机构详情
  - `getMemberships(userId)` - 查询用户加入的机构列表

- **pet-service** (`PetServiceClient`)
  - `updatePetStatus(petId, body)` - 更新宠物状态
    - 使用场景：领养申请通过/拒绝/完成时更新宠物状态

**被调用的服务：**
- **interview-service** 调用
- **pet-service** 调用

---

### 2. pet-service（宠物服务）

**调用的服务：**
- **auth-service** (`AuthServiceClient`)
  - `getUserById(userId)` - 根据用户ID获取用户信息
    - 使用场景：宠物反馈服务中获取用户信息

- **org-service** (`OrgServiceClient`)
  - `getOrgDetail(orgId)` - 获取机构详情
    - 使用场景：获取宠物列表和详情时填充机构名称

- **adoption-service** (`AdoptionServiceClient`)
  - `checkOwnership(petId, userId)` - 检查用户是否领养了该宠物
    - 使用场景：C端用户上传健康状态时验证权限
  - `getAdoptedPetsForReminder(orgId, daysSinceUpdate)` - 获取已领养宠物列表（用于查询逾期未更新）
    - 使用场景：健康记录提醒功能

**被调用的服务：**
- **adoption-service** 调用

---

### 3. interview-service（面谈服务）

**调用的服务：**
- **adoption-service** (`AdoptionServiceClient`)
  - `notifyInterviewRequested(appId)` - 发送面谈预约请求通知给机构管理员
  - `notifyInterviewConfirmed(appId, body)` - 发送面谈确认通知给申请人
  - `completeHandover(appId)` - 完成交接（将申请状态改为 COMPLETED）
  - `getApplicationDetail(appId)` - 获取申请详情（用于获取机构ID）

- **org-service** (`OrgServiceClient`)
  - `getMemberships(userId)` - 查询用户加入的机构列表
    - 使用场景：验证用户是否有权限操作机构的面谈时段

**被调用的服务：**
无

---

### 4. org-service（机构服务）

**调用的服务：**
- **auth-service** (`AuthServiceClient`)
  - `getUserById(userId)` - 根据用户ID获取用户信息
    - 使用场景：机构成员管理中获取用户信息
  - `getUserList(page, pageSize)` - 获取用户列表（用于通知）

**被调用的服务：**
- **adoption-service** 调用
- **pet-service** 调用
- **interview-service** 调用

---

### 5. community-service（社区服务）

**调用的服务：**
- **auth-service** (`AuthServiceClient`)
  - `getUserById(userId)` - 根据用户ID获取用户信息
    - 使用场景：
      - PostService: 获取帖子作者信息
      - CommentService: 获取评论作者信息
      - ReportService: 获取举报人信息
      - ReactionService: 获取点赞用户信息
  - `getUserList(page, pageSize)` - 获取用户列表（用于通知）
    - 使用场景：NotificationMessageService 中批量获取用户信息发送通知

**被调用的服务：**
无

---

### 6. auth-service（认证服务）

**调用的服务：**
无（核心服务，不依赖其他业务服务）

**被调用的服务：**
- **adoption-service** 调用
- **pet-service** 调用
- **org-service** 调用
- **community-service** 调用

---

## 调用统计

### 按服务统计（调用方）

| 服务 | 调用的服务数量 | 调用的服务列表 |
|------|--------------|---------------|
| adoption-service | 3 | auth-service, org-service, pet-service |
| pet-service | 3 | auth-service, org-service, adoption-service |
| interview-service | 2 | adoption-service, org-service |
| org-service | 1 | auth-service |
| community-service | 1 | auth-service |
| auth-service | 0 | 无 |

### 按服务统计（被调用方）

| 服务 | 被调用的次数 | 调用方服务列表 |
|------|------------|---------------|
| auth-service | 5 | adoption-service, pet-service, org-service, community-service |
| org-service | 3 | adoption-service, pet-service, interview-service |
| adoption-service | 2 | pet-service, interview-service |
| pet-service | 1 | adoption-service |

---

## 调用模式分析

### 1. 核心服务模式
- **auth-service** 作为核心服务，被几乎所有其他服务调用
- 主要用于获取用户信息和权限验证

### 2. 双向调用模式
- **adoption-service** ↔ **pet-service**
  - adoption-service 调用 pet-service 更新宠物状态
  - pet-service 调用 adoption-service 验证领养关系和获取已领养宠物列表

### 3. 单向调用模式
- **interview-service** → **adoption-service**
  - 面谈服务调用领养服务完成业务流程和发送通知

### 4. 数据聚合模式
- **pet-service** → **org-service**
  - 宠物服务调用机构服务获取机构信息，用于数据聚合展示

---

## Feign 客户端配置

### 通用配置
所有服务都启用了 Feign 客户端：
- 使用 `@EnableFeignClients` 注解
- 通过 `@FeignClient(name = "service-name", path = "/path")` 声明客户端

### 特殊配置
- **adoption-service** 和 **interview-service** 配置了 `FeignConfig`
  - 用于传递请求头信息（如 `X-User-Id`, `X-Roles`）

---

## 注意事项

1. **循环依赖风险**
   - adoption-service 和 pet-service 存在双向调用，需要注意避免循环依赖

2. **服务降级**
   - 部分调用使用了 try-catch 处理异常，确保服务调用失败不影响主流程

3. **数据一致性**
   - 跨服务操作需要注意数据一致性，特别是状态更新操作

4. **性能考虑**
   - 批量查询时注意避免 N+1 查询问题（如 pet-service 中批量获取机构信息）

---

## 总结

本系统采用典型的微服务架构，各服务职责清晰：
- **auth-service**: 认证和用户管理核心
- **org-service**: 机构管理核心
- **pet-service**: 宠物信息管理
- **adoption-service**: 领养业务流程核心
- **interview-service**: 面谈预约管理
- **community-service**: 社区功能

服务间通过 Feign 进行同步调用，通过 RabbitMQ 进行异步消息传递（通知服务）。

